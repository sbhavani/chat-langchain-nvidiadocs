<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Common API &mdash; Transformer Engine 0.6.0
 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Framework-specific API" href="framework.html" />
    <link rel="prev" title="Getting Started" href="../examples/quickstart.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" > 

          
          
          <a href="../index.html" class="icon icon-home">
            Transformer Engine
          </a>
              <div class="version">
                0.6.0
-f18e677<br/>
Version select: <select onChange="window.location.href = this.value" onFocus="this.selectedIndex = 0">
    <option value="https://docs.nvidia.com/deeplearning/transformer-engine/user-guide/index.html" selected>Current release</option>
    <option value="https://docs.nvidia.com/deeplearning/transformer-engine/archives/index.html">Older releases</option>
</select>
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

  <style>
    /* Sidebar header (and topbar for mobile) */
    .wy-side-nav-search, .wy-nav-top {
      background: #76b900;
    }

    .wy-menu > p > span.caption-text {
      color: #76b900;
    }

    .wy-menu-vertical p {
      height: 32px;
      line-height: 32px;
      padding: 0 1.618em;
      margin: 12px 0 0;
      display: block;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 85%;
      white-space: nowrap;
    }

    .wy-side-nav-search a:link, .wy-nav-top a:link {
      color: #fff;
    }
    .wy-side-nav-search a:visited, .wy-nav-top a:visited {
      color: #fff;
    }
    .wy-side-nav-search a:hover, .wy-nav-top a:hover {
      color: #fff;
    }

    .wy-menu-vertical a:link, .wy-menu-vertical a:visited {
      color: #d9d9d9
    }

    .wy-menu-vertical a:active {
      background-color: #76b900
    }

    .wy-side-nav-search>div.version {
      color: rgba(0, 0, 0, 0.3)
    }

    .wy-nav-content {
      max-width: 1000px;
    }

    /* override table width restrictions */
    .wy-table-responsive table td, .wy-table-responsive table th {
        /* !important prevents the common CSS stylesheets from
          overriding this as on RTD they are loaded after this stylesheet */
        white-space: normal !important;
    }

    .wy-table-responsive {
        overflow: visible !important;
    }

  </style>
  
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Home</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#prerequisites">Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#transformer-engine-in-ngc-containers">Transformer Engine in NGC Containers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../installation.html#pip-from-github">pip - from GitHub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#additional-prerequisites">Additional Prerequisites</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#installation-stable-release">Installation (stable release)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../installation.html#installation-development-build">Installation (development build)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/quickstart.html">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/quickstart.html#Overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/quickstart.html#Let’s-build-a-Transformer-layer!">Let’s build a Transformer layer!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/quickstart.html#Meet-Transformer-Engine">Meet Transformer Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/quickstart.html#Fused-TE-Modules">Fused TE Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/quickstart.html#Enabling-FP8">Enabling FP8</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Python API documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Common API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#classes">Classes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#transformer_engine.common.recipe.Format"><code class="docutils literal notranslate"><span class="pre">Format</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#transformer_engine.common.recipe.DelayedScaling"><code class="docutils literal notranslate"><span class="pre">DelayedScaling</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="framework.html">Framework-specific API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="pytorch.html">pyTorch</a><ul>
<li class="toctree-l3"><a class="reference internal" href="pytorch.html#modules">Modules</a><ul>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.Linear"><code class="docutils literal notranslate"><span class="pre">Linear</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.LayerNorm"><code class="docutils literal notranslate"><span class="pre">LayerNorm</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.LayerNormLinear"><code class="docutils literal notranslate"><span class="pre">LayerNormLinear</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.LayerNormMLP"><code class="docutils literal notranslate"><span class="pre">LayerNormMLP</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.DotProductAttention"><code class="docutils literal notranslate"><span class="pre">DotProductAttention</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.TransformerLayer"><code class="docutils literal notranslate"><span class="pre">TransformerLayer</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="pytorch.html#functions">Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.fp8_autocast"><code class="docutils literal notranslate"><span class="pre">fp8_autocast()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="pytorch.html#transformer_engine.pytorch.checkpoint"><code class="docutils literal notranslate"><span class="pre">checkpoint()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples and Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../examples/fp8_primer.html">Using FP8 with Transformer Engine</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/fp8_primer.html#Introduction-to-FP8">Introduction to FP8</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#Structure">Structure</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#Mixed-precision-training---a-quick-introduction">Mixed precision training - a quick introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#Mixed-precision-training-with-FP8">Mixed precision training with FP8</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples/fp8_primer.html#id1">Using FP8 with Transformer Engine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#FP8-recipe">FP8 recipe</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#FP8-autocasting">FP8 autocasting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#Handling-backward-pass">Handling backward pass</a></li>
<li class="toctree-l3"><a class="reference internal" href="../examples/fp8_primer.html#Precision">Precision</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../examples/advanced_optimizations.html">Performance Optimizations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../examples/advanced_optimizations.html#Multi-GPU-training">Multi-GPU training</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/advanced_optimizations.html#Gradient-accumulation-fusion">Gradient accumulation fusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="../examples/advanced_optimizations.html#FP8-weight-caching">FP8 weight caching</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="c/index.html">C/C++ API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="c/activation.html">activation.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/cast.html">cast.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/gemm.html">gemm.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/layer_norm.html">layer_norm.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/softmax.html">softmax.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/transformer_engine.html">transformer_engine.h</a></li>
<li class="toctree-l2"><a class="reference internal" href="c/transpose.html">transpose.h</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Transformer Engine</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Common API</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/api/common.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<section id="common-api">
<h1>Common API<a class="headerlink" href="#common-api" title="Permalink to this heading">¶</a></h1>
<section id="classes">
<h2>Classes<a class="headerlink" href="#classes" title="Permalink to this heading">¶</a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="transformer_engine.common.recipe.Format">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">transformer_engine.common.recipe.</span></span><span class="sig-name descname"><span class="pre">Format</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">value</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#transformer_engine.common.recipe.Format" title="Permalink to this definition">¶</a></dt>
<dd><p>Supported FP8 formats.</p>
<dl class="field-list simple">
<dt class="field-odd">Values<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>E4M3</strong> – All FP8 tensors are in e4m3 format</p></li>
<li><p><strong>E5M2</strong> – All FP8 tensors are in e5m2 format</p></li>
<li><p><strong>HYBRID</strong> – FP8 tensors in the forward pass are in e4m3 format,
FP8 tensors in the backward pass are in e5m2 format</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="transformer_engine.common.recipe.DelayedScaling">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">transformer_engine.common.recipe.</span></span><span class="sig-name descname"><span class="pre">DelayedScaling</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">margin</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">interval</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fp8_format</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">Format.E4M3</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">amax_history_len</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">amax_compute_algo</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'most_recent'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">scaling_factor_compute_algo</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">override_linear_precision</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(False,</span> <span class="pre">False,</span> <span class="pre">False)</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#transformer_engine.common.recipe.DelayedScaling" title="Permalink to this definition">¶</a></dt>
<dd><p>Use the delayed scaling factor strategy.
Use scale factor from previous iteration,
recompute once every <cite>interval</cite>, and record
amax history of <cite>amax_history_len</cite> steps.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>margin</strong> (<em>int</em><em>, </em><em>default = 0</em>) – Margin for the scaling factor computation.</p></li>
<li><p><strong>interval</strong> (<em>int</em><em>, </em><em>default = 1</em>) – Controls how often the scaling factor is recomputed.</p></li>
<li><p><strong>fp8_format</strong> (<em>{Format.E4M3</em><em>, </em><em>Format.HYBRID}</em><em>, </em><em>default = Format.HYBRID</em>) – Controls the FP8 data format used during forward and backward
pass.</p></li>
<li><p><strong>amax_history_len</strong> (<em>int</em><em>, </em><em>default = 1</em>) – The length of the amax history window used for
scaling factor computation.</p></li>
<li><p><strong>amax_compute_algo</strong> (<em>{'max'</em><em>, </em><em>'most_recent'</em><em>, </em><em>Callable}</em><em>, </em><em>default = 'most_recent'</em>) – <p>Algorithm used for choosing the <cite>amax</cite> value for the
scaling factor computation. There are 2 predefined
choices: <cite>max</cite> chooses the largest <cite>amax</cite> in the history
window, while <cite>most_recent</cite> always chooses the most recently
seen value. Alternatively, one may pass a function of the
signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">amax_compute</span><span class="p">(</span><span class="n">amax_history</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span>
</pre></div>
</div>
<p>where <cite>Tensor</cite> is a framework tensor type.</p>
</p></li>
<li><p><strong>scaling_factor_compute_algo</strong> (<em>Callable</em><em>, </em><em>default = None</em>) – <p>Algorithm used for computing the new scaling
factor based on the value of <cite>amax</cite>. It should
be a function of the signature:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">scaling_factor_compute</span><span class="p">(</span><span class="n">amax</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                           <span class="n">old_scaling_factor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                           <span class="n">fp8_max</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span>
                           <span class="n">recipe</span><span class="p">:</span> <span class="n">DelayedScaling</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span>
</pre></div>
</div>
<p>where <cite>Tensor</cite> is a framework tensor type.</p>
</p></li>
<li><p><strong>override_linear_precision</strong> (<em>Tuple</em><em>(</em><em>bool</em><em>, </em><em>bool</em><em>, </em><em>bool</em><em>)</em><em>, </em><em>default=</em><em>(</em><em>False</em><em>, </em><em>False</em><em>, </em><em>False</em><em>)</em>) – Whether or not the execute the <cite>fprop</cite>, <cite>dgrad</cite>, and <cite>wgrad</cite>
GEMMs (respectively) in higher precision when using FP8.</p></li>
<li><p><strong>reduce_amax</strong> (bool, default = <cite>True</cite>) – By default, if <cite>torch.distributed</cite> is initialized, the <cite>amax</cite> value for FP8
tensors is reduced across the <cite>fp8_group</cite> (specified in the <cite>fp8_autocast</cite>
call). This keeps the amaxes and scaling factors synced across the given
distributed group. If set to <cite>False</cite>, this reduction is skipped and every
GPU maintains local amaxes and scaling factors. To ensure results are
numerically identical across checkpointing boundaries in this case, all
ranks must checkpoint in order to store the local tensors.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Notes</p>
<ul>
<li><p>By default (when <cite>scaling_factor_compute_algo</cite> is left as <cite>None</cite>) the scaling
factor is computed from the final <cite>amax</cite> value using the formula:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FP8_MAX</span> <span class="o">=</span> <span class="n">maximum_representable_value</span><span class="p">(</span><span class="n">fp8_format</span><span class="p">)</span>
<span class="n">exp</span> <span class="o">=</span> <span class="n">get_exponent</span><span class="p">(</span><span class="n">FP8_MAX</span> <span class="o">/</span> <span class="n">amax</span><span class="p">)</span> <span class="o">-</span> <span class="n">margin</span>
<span class="n">new_scaling_factor</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">^</span> <span class="n">exp</span>
</pre></div>
</div>
</li>
<li><p>The scaling factor should always be a power of 2 to not introduce numerical
error during the conversion from FP8 to higher precision format.</p></li>
</ul>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../examples/quickstart.html" class="btn btn-neutral float-left" title="Getting Started" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="framework.html" class="btn btn-neutral float-right" title="Framework-specific API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022-2023, NVIDIA CORPORATION &amp; AFFILIATES. All rights reserved..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>  

  <style>
  a:link, a:visited {
    color: #76b900;
  }

  a:hover {
    color: #8c0;
  }

  html.writer-html5 .rst-content dl[class]:not(.option-list):not(.field-list):not(.footnote):not(.glossary):not(.simple)>dt {
    background: rgba(118, 185, 0, 0.1);
    color: rgba(59,93,0,1);
    border-top: solid 3px rgba(59,93,0,1);
  }

  html.writer-html4 .rst-content dl:not(.docutils) .property, html.writer-html5 .rst-content dl[class]:not(.option-list):not(.field-list):not(.footnote):not(.glossary):not(.simple) .property {
    text-transform: capitalize;
    display: inline-block;
    padding-right: 8px;
  }
  </style>

  

</body>
</html>